<div class="w3-panel">
   <?= View::Encab($controller_name, $page_action, $breadcrumb); ?>
   <?= View::flash(); ?>

   <div class="w3-row w3-section">
      <?=OdaForm::inputSearch();?>
   </div>
   
   <?php 
   try {

      $ico_man = '<i class="fa-solid fa-person w3-large"></i>';
      $ico_woman = '<i class="fa-solid fa-person-dress w3-large"></i>';
      $tabla = new OdaTable(theme: $theme, showTotalRegs: true);
      $tabla->setHead(
         data_head:    ['Actions', 'Estudiante', 'Cambiar Salon'], 
         attrs:         'class="w3-theme"', 
         arr_attrs_th: ['style="width:10%;"','style="width:60%;"','style="width:30%;"']
      );

      $arrMatriculas = [];
      $tot_estudiantes = 0;
      $tot_matriculados = 0;
      foreach($data as $key => $Estud) {
        $tot_estudiantes += 1;
        $lnk_gen_num_mat = '<br>'.OdaTags::tag('span', "Matrícula #{$Estud->numero_mat_f()}", 'class="w3-tag"');
        if ( empty($Estud->numero_mat) ) {
          $lnk_gen_num_mat = '<br>'.OdaTags::linkButton(
            action: "admin/estudiantes/generarNumeroMatricula/{$Estud->id}", 
            text: 'Generar Número Matricula', 
            attrs: 'class="w3-button w3-green"',
          );
        } else {
          $arrMatriculas[$Estud->grado_promovido] += 1;
          $tot_matriculados += 1;
        }

         $col1 = $Estud->is_active_f(true) .'<br/>'
                .$Estud->getFoto().'<br/>'
                .$Estud->documento .'<br/><br/>Retirar Estudiante<br/>'
                .$Estud->getLnkRetirar(RetiroEstudiante::Voluntario)
                .$Estud->getLnkRetirar(RetiroEstudiante::Institucion)
                .$Estud->getLnkRetirar(RetiroEstudiante::Graduacion);

        $col2 = "Grado: $Estud->grado_nombre [$Estud->salon_nombre] <br>"
                 ."<h3>{$Estud->getLnkEditPage($Estud)} {$Estud->isNuevoIco()}</h3>"
                 ."{$Estud->getPagoPension()} {$Estud->getlnkSetPonerAldia()} <br> 
                   {$Estud->getDebePreicfes()} - {$Estud->getDebeAlmuerzos()} <br>"
                 .$Estud->getlnkSetMesPagosTodos().'<br>'
                 .'Boletines '.$Estud->getLnkBoletinesTodos().'<hr>'
                 .'Cambiar de Salón  '.$Estud->getSalonesCambiar('secretaria').'<br>';
        
        $col3  = 
                '<div clasas="w3-panel w3-teal">'.$lnk_gen_num_mat.'<br>'
                .$Estud->getEstadoMat()->label_ico().'<hr>'

                .$ico_woman. (($Estud->madre) ? "$Estud->madre<br>" : '')
                .(($Estud->madre_email) ? "$Estud->madre_email<br>" : '')
                .(($Estud->madre_id) ? "$Estud->madre_id<br>" : '<br>')
                .OdaUtils::linkWhatsApp(telefono: (string)$Estud->madre_tel_1)
                .OdaUtils::linkTelefono(telefono: (string)$Estud->madre_tel_1, show_tel:true).'<hr>'

                .$ico_man .(($Estud->padre) ? "$Estud->padre<br>" : '')
                .(($Estud->padre_email) ? "$Estud->padre_email<br>" : '')
                .(($Estud->padre_id) ? "$Estud->padre_id<br>" : '<br>')
                .OdaUtils::linkWhatsApp(telefono: (string)$Estud->padre_tel_1)
                .OdaUtils::linkTelefono(telefono: (string)$Estud->padre_tel_1, show_tel:true);

         $data=[$col1, $col2, $col3];
         $tabla->addRow(
            data: $data, 
            attrs_td: ['class="searchTdata w3-center"', 'class="searchTdata"']
         );
      }
      
      $btns_listas_clase = '';
      foreach ($arrData['Salones'] as $key => $value) {
        $btns_listas_clase .= (new Estudiante)::getLnkListaGenerica($value->id) ;
      }


      $arrGrados = Grado::getGradosArray();
      $resultados_mat = '';
      foreach ($arrMatriculas as $key => $value) {
        $resultados_mat .= OdaTags::Badges($arrGrados[$key], $value);
      }
      $tot_sin_matricula = $tot_estudiantes-$tot_matriculados;


      $lnk_listado_mat = OdaTags::linkButton(
        action: "admin/estudiantes/exportListMatriculadosPdf", 
        text: 'Matriculados PDF', 
        attrs: 'class="w3-button w3-green" target="_blank"'
      );

      $lnk_listado_pendientes_mat = OdaTags::linkButton(
        action: "admin/estudiantes/exportListPendientesMatriculaPdf", 
        text: 'Pendientes x Matricular PDF', 
        attrs: 'class="w3-button w3-blue" target="_blank"'
      );

      echo "
      <div class=\"w3-row\">

        <div class=\"w3-half\">
          <div class=\"w3-padding\">
            <h3>Listas de Clase</h3>
            $btns_listas_clase
          </div>
        </div>

        <div class=\"w3-half\">
          <div class=\"w3-padding w3-bar\">
            <h3>Matriculados [$tot_matriculados] / Faltan {$tot_sin_matricula}</h3>
            $resultados_mat
          </div>
          <p>$lnk_listado_mat $lnk_listado_pendientes_mat<p>
        </div>

      </div>
      ";
      echo $tabla;


    } catch (\Throwable $th) {
      OdaLog::error($th);
      echo $th;
     }

   ?>   
</div>

<?= Tag::js(src: "table_filter"); ?>